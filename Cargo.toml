[package]
name = "kwavers"
version = "3.0.0"
edition = "2021"
authors = ["Ryan Clanton PhD <ryanclanton@outlook.com>"]
description = "Ultrasound Simulation Toolbox with Cavitation and Light Physics"
license = "MIT"
repository = "https://github.com/ryancinsight/kwavers"
keywords = ["ultrasound", "simulation", "physics", "cavitation", "sonoluminescence", "medical-imaging"]
categories = ["science", "simulation", "medical"]

[dependencies]
# CORE PRODUCTION DEPENDENCIES ONLY
# Following minimalist production architecture per ADR-011

# Essential numerical computing
ndarray = { version = "0.16", features = ["rayon", "serde"] }
rayon = "1.10"
rustfft = "6.2"
num-complex = "0.4"
num-traits = "0.2"

# Error handling (production critical)
thiserror = "1.0"
anyhow = "1.0"

# Serialization (minimal)
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
toml = "0.8"

# Unit safety
uom = { version = "0.36", default-features = false, features = ["f64", "si", "std"] }

# Linear algebra
nalgebra = { version = "0.32" }

# Essential utilities
log = "0.4"
env_logger = "0.11"
tracing = { version = "0.1", features = ["attributes"] }
bitflags = "2.4"
rand = "0.8"
rand_distr = "0.4"
rand_chacha = "0.3"
regex = "1.8"
nifti = "0.17.0"
chrono = { version = "0.4", features = ["serde"] }
base64 = "0.22"

# Async runtime (Sprint 138 - Persona Requirements)
tokio = { version = "1.42", features = ["rt-multi-thread", "macros", "sync", "time", "fs", "io-util"], optional = true }
futures = "0.3"
tracing-subscriber = { version = "0.3", features = ["env-filter", "fmt"], optional = true }

# Zero-copy serialization (Sprint 138 - Persona Requirements)
rkyv = { version = "0.7", features = ["validation"], optional = true }

# Cloud dependencies (Sprint 159)
reqwest = { version = "0.11", optional = true }
# google-cloud-aiplatform = { version = "0.5", optional = true }
# google-cloud-functions = { version = "0.1", optional = true }
# azure_functions = { version = "0.1", optional = true }
# azure_ai = { version = "0.1", optional = true }

# Concurrency
parking_lot = "0.12"
once_cell = "1.19"
flume = "0.11"

# Testing utilities (minimal)
approx = "0.5"

# CONDITIONAL FEATURES (disabled by default)
# GPU acceleration (optional)
wgpu = { version = "22.0", features = ["wgsl"], optional = true }
bytemuck = { version = "1.19", features = ["derive"], optional = true }
pollster = { version = "0.4", optional = true }

# Machine Learning (Sprint 143 - PINNs with burn integration)
# Updated to burn 0.18.0 (bincode compatibility resolved)
burn = { version = "0.19", features = ["ndarray", "autodiff", "wgpu"], optional = true }

# Visualization (optional)
plotly = { version = "0.8", optional = true }
egui = { version = "0.25", optional = true }

# Enterprise API (Sprint 159 - Production Deployment)
axum = { version = "0.7", features = ["json", "tracing", "macros"], optional = true }
tower = { version = "0.4", features = ["util"], optional = true }
tower-http = { version = "0.5", features = ["cors", "trace", "compression-gzip", "request-id", "util"], optional = true }
jsonwebtoken = { version = "9.0", optional = true }
bcrypt = { version = "0.15", optional = true }
uuid = { version = "1.0", features = ["v4", "serde"], optional = true }
sha2 = { version = "0.10", optional = true }
hmac = { version = "0.12", optional = true }
redis = { version = "0.25", optional = true }
deadpool-redis = { version = "0.14", optional = true }
prometheus = { version = "0.14", optional = true }
opentelemetry = { version = "0.21", features = ["trace", "metrics"], optional = true }
opentelemetry-prometheus-text-exporter = { version = "0.2", optional = true }



# Cloud deployment (Sprint 159 - Production Deployment)
aws-sdk-sagemaker = { version = "1.0", optional = true }
aws-sdk-lambda = { version = "1.0", optional = true }
aws-sdk-ec2 = { version = "1.0", optional = true }
aws-sdk-elasticloadbalancingv2 = { version = "1.0", optional = true }
aws-sdk-autoscaling = { version = "1.0", optional = true }
aws-sdk-applicationautoscaling = { version = "1.0", optional = true }
aws-config = { version = "1.0", optional = true }

[dev-dependencies]
# Minimal dev dependencies for testing only
criterion = "0.4"
proptest = "1.2"

# Async testing support
tokio = { version = "1.42", features = ["rt-multi-thread", "macros"] }

# Concurrency testing (Sprint 138 - Persona Requirements)
loom = "0.7"

[features]
default = ["minimal"]  # PRODUCTION DEFAULT
minimal = []           # Core functionality only
parallel = ["ndarray/rayon"] # Add back parallel feature
gpu = ["dep:wgpu", "dep:bytemuck", "dep:pollster"]
plotting = ["dep:plotly"]
# Additional features referenced in code
nifti = []             # Medical imaging support
nightly = []           # Nightly Rust features
simd = []              # SIMD acceleration support
fpu = []               # FPU acceleration support
advanced-visualization = ["plotting"] # Advanced visualization features
web-visualization = ["plotting"]      # Web-based visualization
gpu-visualization = ["gpu", "plotting", "dep:egui"] # GPU-accelerated visualization
vr-support = []        # VR headset support (future)
# Sprint 138 - Persona Requirements
async-runtime = ["dep:tokio"]        # Async I/O with tokio
structured-logging = ["dep:tracing-subscriber"]  # Tracing infrastructure
zero-copy = ["dep:rkyv"]             # Zero-copy serialization
# Sprint 142-143 - Physics-Informed Neural Networks
# Sprint 143: Added burn 0.18 integration (bincode compatibility resolved)
pinn = ["dep:burn"]                  # Physics-informed neural networks with burn 0.18
pinn-gpu = ["pinn", "gpu"]           # PINN with GPU acceleration via WGPU
burn-wgpu = ["pinn"]                 # Burn WGPU backend support (for cfg checks)
burn-cuda = ["pinn"]                 # Burn CUDA backend support (for cfg checks)
experimental_neural = ["pinn"]        # Gate experimental neural beamforming atop PINN deps
# Adaptive Beamforming Refactor - Sprint ADR-001
legacy_algorithms = []               # Legacy beamforming algorithms (deprecated)
# Sprint 159 - Enterprise API for production deployment
api = ["dep:axum", "dep:tower", "dep:tower-http", "async-runtime", "structured-logging", "dep:jsonwebtoken", "dep:sha2", "dep:uuid", "dep:prometheus"]  # REST API for clinical ultrasound with cloud deployment
cloud = ["dep:reqwest", "dep:uuid", "async-runtime", "structured-logging"]
full = ["gpu", "plotting", "parallel", "nifti", "advanced-visualization", "gpu-visualization", "async-runtime", "structured-logging", "zero-copy", "pinn", "api", "cloud"]

[profile.dev]
# Fast development builds
opt-level = 0
debug = true
split-debuginfo = "unpacked"
codegen-units = 256

[profile.release]
# Optimized for performance
opt-level = 3
lto = "thin"
codegen-units = 1
panic = "abort"

[profile.test]
# SRS NFR-002 compliant: optimize for fast compilation (<30s total)
opt-level = 0          # Minimize optimization time
debug = false          # Reduce binary size and compilation time
codegen-units = 256    # Maximize parallelization
incremental = true     # Enable incremental compilation
debug-assertions = false # Skip expensive debug checks

# SRS NFR-002 Compliant Test Configuration Strategy
# ================================================
# TIER 1: Fast unit tests (<10s) - Always run in CI/CD
# - Library unit tests: cargo test --lib
# - Fast integration tests below
#
# TIER 2: Standard tests (<30s) - Run on PR validation
# - All tests in tests/ directory with required-features = []
#
# TIER 3: Comprehensive validation (>30s) - Run on release validation
# - Tests requiring "full" feature set
# - Literature validation benchmarks
# - Physics validation suites

# TIER 1: Fast integration tests (<10s execution)
[[test]]
name = "infrastructure_test"
harness = true
required-features = []

[[test]]
name = "integration_test"
harness = true
required-features = []

[[test]]
name = "fast_unit_tests"
harness = true
required-features = []

[[test]]
name = "simple_integration_test"
harness = true
required-features = []

# TIER 2: Standard validation tests (<30s each when run separately)
[[test]]
name = "cfl_stability_test"
harness = true
required-features = []

[[test]]
name = "energy_conservation_test"
harness = true
required-features = []

# TIER 3: Comprehensive validation tests (>30s) - Requires full feature set
[[test]]
name = "validation_suite"
harness = true
required-features = ["full"]

[[test]]
name = "literature_validation"
harness = true
required-features = ["full"]

[[test]]
name = "physics_validation_test"
harness = true
required-features = ["full"]

[[test]]
name = "rigorous_physics_validation"
harness = true
required-features = ["full"]

[[test]]
name = "solver_test"
harness = true
required-features = ["full"]

[[test]]
name = "absorption_validation_test"
harness = true
required-features = ["full"]

[[test]]
name = "dispersion_validation_test"
harness = true
required-features = ["full"]

[[test]]
name = "elastic_wave_validation"
harness = true
required-features = ["full"]

[[test]]
name = "fdtd_pstd_comparison"
harness = true
required-features = ["full"]

[[test]]
name = "physics_validation"
harness = true
required-features = ["full"]

[lib]
test = true

# BENCHMARK CONFIGURATION (Sprint 107 - P0 Priority)
# ===================================================
# Statistical performance benchmarks using criterion
# Execute: cargo bench (full suite) or cargo bench --bench <name> (individual)
# Purpose: Establish baseline metrics for optimization tracking
# Target: Document performance characteristics per ADR-010

[[bench]]
name = "performance_baseline"
harness = false

[[bench]]
name = "critical_path_benchmarks"
harness = false

[[bench]]
name = "grid_benchmarks"
harness = false

[[bench]]
name = "physics_benchmarks"
harness = false

[[bench]]
name = "cpml_benchmark"
harness = false

[[bench]]
name = "testing_infrastructure"
harness = false

[[bench]]
name = "validation_benchmarks"
harness = false

[[bench]]
name = "pinn_elastic_2d_training"
harness = false
required-features = ["pinn"]

[[bench]]
name = "opast_benchmarks"
harness = false
required-features = ["legacy_algorithms"]

[lints.rust]
unexpected_cfgs = { level = "warn", check-cfg = ['cfg(loom)'] }
